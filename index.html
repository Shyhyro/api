<!DOCTYPE html>
<html>
<head>
    <title>Realmerge for Horse Reality</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta property="og:title" content="Realmerge"/>
    <meta property="og:description" content="Simple tool that layers files from the Horse Reality webgame."/>
    <meta property="og:image" content="https://realmerge.shay.cat/static/promo-og-light-bg-1.png"/>
    <meta property="twitter:card" content="summary_large_image"/>
    <meta name="theme-color" content="#081b28"/>
    <link rel="stylesheet" href="/static/style.css"/>
    <script>
        // if someone requests the same URL multiple times, cache the name
        // here instead of on the server
        const namecache = {};

        function displayError(message) {
            document.getElementById('error-message').innerHTML = message;
            document.getElementById('error-box').style.display = 'block';
            document.getElementById('merged-image-box').style.display = 'none';
        }

        async function mergeImage() {
            // basic UX in case the request takes a long time
            const horseurl = document.getElementById('horseurl').value;
            document.getElementById('merged-image-title').innerHTML = 'Processing...';
            document.getElementById('merged-image').src = '';
            document.getElementById('horseurl').value = null;

            if (!horseurl) {
                displayError('Input box must not be empty.');
                return
            }

            document.getElementById('merged-image-box').style.display = 'block';
            document.getElementById('merged-image-title').innerHTML = 'Merging...';

            const response = await fetch('/api/merge', {
                method: 'POST',
                body: JSON.stringify({url: horseurl}),
                headers: {'Content-Type': 'application/json'}
            });
            const data = await response.json();
            if (!response.ok) {
                displayError(data.message);
                return
            } else {
                document.getElementById('error-box').style.display = 'none';
                document.getElementById('merged-image-box').style.display = 'block';
                // it might be hidden if the previous
                // request resulted in an error
            }

            if (response.status == 200) {
                // 200 OK is only returned when the image is already merged
                // this could be more clearly indicated but, eh
                // https://github.com/shayypy/realmerge/blob/main/web.py#L192-L197
                if (namecache[data.original_url] & !data.name) {
                    data.name = namecache[data.original_url];
                }
            }

            document.getElementById('merged-image').src = data.url;
            if (!data.name) {
                document.getElementById('merged-image-title').innerHTML = 'Merged Image';
            } else {
                document.getElementById('merged-image-title').innerHTML = data.name;
                namecache[data.original_url] = data.name
            }
        }
    </script>
</head>
<body>
<iframe style="display:none" name="hide-form-req"></iframe>
<div class="box">
    <h3 class="box-title">Realmerge</h3>
    <form target="hide-form-req" action="/api/eat" method="POST" onsubmit="mergeImage();">
        <input required pattern="^https:\/\/(v2\.|www\.)?horsereality\.(com|nl)\/horses\/(\d{3,10})\/.*" type="url" name="url" id="horseurl" placeholder="https://horsereality.com/horses/...">
        <button type="submit" id="submitbutton">Generate</button>
    </form>
</div>
<div class="box" id="error-box" style="padding-bottom:20px;display:none;border-color:red">
    <h3 class="box-title">Error</h3>
    <p style="margin:0" id="error-message"></p>
</div>
<div class="box" id="merged-image-box" style="padding-bottom:20px;display:none">
    <h3 class="box-title" id="merged-image-title"></h3>
    <img id="merged-image" src="">
</div>
<div class="footer-credit">
    <h5 style="margin:0">ðŸ”— All images Â© <a href="https://deloryan.com" target="_blank">Deloryan B.V.</a></h5>
    <h5 style="margin:0">ðŸ”— Source on <a href="https://github.com/shayypy/realmerge" target="_blank">GitHub</a>. Realmerge Â© shay (shayypy)</h5>
</div>
<div class="footer-credit" id="extension-ad-chromium" style="right:20px;display:none">
    <h5 style="margin:0">Realmerge has a browser extension! <a href="/chrome" target="_blank">You can add it here :)</a></h5>
</div>
<div class="footer-credit" id="extension-ad-firefox" style="right:20px;display:none">
    <h5 style="margin:0">Realmerge has a browser extension! <a href="/firefox" target="_blank">You can add it here :)</a></h5>
</div>
<script>
    if (window.chrome) {
        document.getElementById('extension-ad-chromium').style.display = 'block';
    } else if (navigator.userAgent.indexOf("Firefox")) {
        document.getElementById('extension-ad-firefox').style.display = 'block';
    }
</script>
</body>
</html>
